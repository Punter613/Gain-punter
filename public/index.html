<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SKSK ProTech – AI Auto Estimator</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
      padding: 1rem;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Access Gate */
    #accessGate {
      position: fixed;
      inset: 0;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 9999;
    }

    #accessGate.hidden {
      display: none;
    }

    .access-card {
      background: #111827;
      border: 2px solid #dc2626;
      border-radius: 12px;
      padding: 2rem;
      max-width: 420px;
      width: 100%;
      text-align: center;
    }

    .access-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .access-subtitle {
      color: #dc2626;
      font-size: 0.95rem;
      margin-bottom: 1.5rem;
    }

    .access-input {
      width: 100%;
      padding: 0.75rem 1rem;
      background: #000;
      border: 2px solid #dc2626;
      border-radius: 8px;
      color: #fff;
      font-size: 1rem;
      text-align: center;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 1rem;
    }

    .access-button,
    .free-button {
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      border: 2px solid transparent;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 0.5rem;
    }

    .access-button {
      background: #dc2626;
      border-color: #b91c1c;
      color: #fff;
    }

    .free-button {
      background: #111827;
      border-color: #4b5563;
      color: #e5e7eb;
    }

    .free-button span {
      display: block;
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 0.1rem;
    }

    .access-button:disabled {
      background: #4b5563;
      border-color: #4b5563;
      cursor: not-allowed;
    }

    .access-msg {
      margin-top: 0.75rem;
      font-size: 0.8rem;
      display: none;
    }

    #accessError {
      color: #fca5a5;
    }

    #accessWelcome {
      color: #bbf7d0;
    }

    .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 999px;
      display: inline-block;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Main App */
    #mainApp {
      display: none;
    }

    #mainApp.visible {
      display: block;
    }

    .header {
      text-align: center;
      padding: 1.5rem 0;
    }

    .logo-mark {
      width: 64px;
      height: 64px;
      margin: 0 auto 0.75rem;
      border-radius: 12px;
      border: 2px solid #dc2626;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #020617;
    }

    .logo-mark span {
      font-weight: 800;
      font-size: 1.25rem;
      letter-spacing: 0.05em;
      color: #dc2626;
    }

    h1 {
      font-size: 2.2rem;
      font-weight: 800;
      letter-spacing: 0.03em;
    }

    .subtitle {
      color: #dc2626;
      font-weight: 600;
      margin-top: 0.25rem;
    }

    .tagline {
      color: #9ca3af;
      font-size: 0.9rem;
      margin-top: 0.4rem;
    }

    .user-info {
      margin-top: 1rem;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid #22c55e;
      border-radius: 8px;
      padding: 0.6rem 0.75rem;
      font-size: 0.85rem;
      text-align: center;
      color: #bbf7d0;
    }

    .user-info button {
      margin-left: 0.75rem;
      padding: 0.2rem 0.6rem;
      font-size: 0.75rem;
      border-radius: 4px;
      border: 1px solid #dc2626;
      background: transparent;
      color: #fecaca;
      cursor: pointer;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.25rem;
      margin-top: 1.25rem;
    }

    @media (min-width: 768px) {
      .grid {
        grid-template-columns: 1.05fr 0.95fr;
      }
    }

    .card {
      background: #111827;
      border-radius: 12px;
      border: 1px solid #27272a;
      padding: 1.25rem;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
    }

    .card h2 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    .pill {
      font-size: 0.7rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.15);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: #e5e7eb;
    }

    .pill.pro-pill {
      background: rgba(37, 99, 235, 0.15);
      border-color: rgba(59, 130, 246, 0.7);
      color: #bfdbfe;
    }

    .form-group {
      margin-bottom: 0.85rem;
      font-size: 0.9rem;
    }

    label {
      display: block;
      color: #e5e7eb;
      margin-bottom: 0.3rem;
      font-size: 0.8rem;
      font-weight: 500;
    }

    input, textarea, select {
      width: 100%;
      padding: 0.6rem 0.8rem;
      background: #020617;
      border-radius: 8px;
      border: 1px solid #27272a;
      color: #f9fafb;
      font-size: 0.9rem;
      font-family: inherit;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #dc2626;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    small {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    button {
      font-family: inherit;
    }

    #submitBtn {
      width: 100%;
      margin-top: 0.5rem;
      padding: 0.7rem 1rem;
      border-radius: 8px;
      border: 0;
      background: #dc2626;
      border: 1px solid #b91c1c;
      color: #fff;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
    }

    #submitBtn:disabled {
      background: #374151;
      border-color: #374151;
      cursor: not-allowed;
    }

    .error, .success {
      margin-bottom: 0.7rem;
      padding: 0.6rem 0.7rem;
      border-radius: 8px;
      font-size: 0.8rem;
    }

    .error {
      background: rgba(220, 38, 38, 0.16);
      border: 1px solid #dc2626;
      color: #fecaca;
    }

    .success {
      background: rgba(34, 197, 94, 0.16);
      border: 1px solid #22c55e;
      color: #bbf7d0;
    }

    .empty-state {
      text-align: center;
      padding: 2.2rem 1rem;
      color: #6b7280;
      font-size: 0.9rem;
    }

    .empty-state strong {
      display: block;
      color: #e5e7eb;
      margin-bottom: 0.3rem;
    }

    .info-box {
      background: #020617;
      border-radius: 8px;
      border: 1px solid #27272a;
      padding: 0.75rem 0.9rem;
      margin-bottom: 0.5rem;
    }

    .info-box h3 {
      font-size: 0.95rem;
      margin-bottom: 0.2rem;
    }

    .info-box p {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .part-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      margin: 0.2rem 0;
      color: #d1d5db;
    }

    .part-row.total {
      border-top: 1px solid #374151;
      padding-top: 0.35rem;
      margin-top: 0.4rem;
      font-weight: 600;
      color: #e5e7eb;
    }

    .total-box {
      margin-top: 0.75rem;
      margin-bottom: 0.75rem;
      padding: 0.8rem 0.9rem;
      border-radius: 10px;
      background: linear-gradient(90deg, #dc2626, #b91c1c);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.95rem;
      font-weight: 700;
    }

    .total-box span:last-child {
      font-size: 1.1rem;
    }

    .tax-box {
      background: rgba(251, 191, 36, 0.08);
      border-radius: 8px;
      border: 1px solid #fbbf24;
      padding: 0.7rem 0.9rem;
      font-size: 0.8rem;
      margin-bottom: 0.5rem;
    }

    .tax-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.15rem;
      color: #fef08a;
    }

    .tax-row.takehome {
      margin-top: 0.35rem;
      padding-top: 0.3rem;
      border-top: 1px solid #fbbf24;
      color: #fefce8;
      font-weight: 600;
    }

    .tax-note {
      font-size: 0.7rem;
      color: #fef08a;
      margin-top: 0.25rem;
    }

    .pro-section {
      border-radius: 8px;
      border: 1px dashed #1f2937;
      padding: 0.7rem 0.7rem 0.6rem;
      margin-bottom: 0.8rem;
      background: radial-gradient(circle at top left, rgba(31,41,55,0.7), transparent 55%);
    }

    .pro-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      margin-bottom: 0.4rem;
    }

    .pro-label {
      color: #bfdbfe;
      font-weight: 600;
      font-size: 0.75rem;
    }

    .pro-hint {
      font-size: 0.7rem;
      color: #9ca3af;
    }

    .pro-disabled {
      opacity: 0.45;
      pointer-events: none;
    }

    .pro-tag {
      display: inline-block;
      padding: 0.05rem 0.45rem;
      border-radius: 999px;
      border: 1px solid rgba(59,130,246,0.7);
      color: #bfdbfe;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .flex-row {
      display: flex;
      gap: 0.45rem;
      align-items: center;
    }

    .quick-rate-row {
      display: flex;
      gap: 0.35rem;
      margin-top: 0.35rem;
    }

    .quick-btn {
      flex: 1;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #020617;
      color: #9ca3af;
      font-size: 0.75rem;
      padding: 0.25rem 0.3rem;
      cursor: pointer;
    }

    .quick-btn:hover {
      border-color: #dc2626;
      color: #f9fafb;
    }

    /* Pro Paywall */
    #proPaywall {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 1rem;
    }

    .paywall-card {
      background: #0b1220;
      border-radius: 16px;
      border: 2px solid #dc2626;
      max-width: 420px;
      width: 100%;
      padding: 1.5rem;
    }

    .paywall-card h2 {
      font-size: 1.4rem;
      margin-bottom: 0.25rem;
      text-align: center;
    }

    .paywall-card p {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 0.9rem;
      text-align: center;
    }

    .paywall-input {
      width: 100%;
      padding: 0.65rem 0.8rem;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #f9fafb;
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
    }

    .paywall-primary {
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 10px;
      border: 0;
      background: #dc2626;
      color: #fff;
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
    }

    .paywall-secondary {
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 10px;
      border: 1px solid #dc2626;
      background: #020617;
      color: #fff;
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
    }

    .paywall-cancel {
      width: 100%;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: 0;
      background: transparent;
      color: #9ca3af;
      font-size: 0.85rem;
      cursor: pointer;
      text-align: center;
    }
  </style>
</head>
<body>

  <!-- ACCESS GATE -->
  <div id="accessGate">
    <div class="access-card">
      <div class="access-title">SKSK ProTech</div>
      <div class="access-subtitle">AI-Powered Auto Estimator</div>

      <p style="font-size:0.8rem; color:#9ca3af; margin-bottom:0.75rem;">
        Unlock full Pro mode with an access code, or jump in on the free limited version.
      </p>

      <form id="accessForm" style="margin-bottom:0.5rem;">
        <input
          type="text"
          id="accessCodeInput"
          class="access-input"
          placeholder="ENTER PRO ACCESS CODE"
          maxlength="24"
        >
        <button type="submit" id="accessSubmit" class="access-button">
          Unlock Pro
        </button>
      </form>

      <button type="button" id="freeAccessBtn" class="free-button">
        Start Free – Limited Features
        <span>Core AI estimate only • Pro tools locked</span>
      </button>

      <div id="accessError" class="access-msg"></div>
      <div id="accessWelcome" class="access-msg"></div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="mainApp">
    <div class="container">
      <div class="header">
        <div class="logo-mark">
          <span>SKSK</span>
        </div>
        <h1>SKSK ProTech</h1>
        <div class="subtitle">Your new shop sidekick.</div>
        <div class="tagline">
          You're good at what you do. Now let's make it easier, faster, more accurate, and automatic.
        </div>
        <div id="userInfo" class="user-info"></div>
      </div>

      <!-- SIMPLE PRO PRICING CARD INSIDE APP -->
      <div class="card" style="margin-bottom:1.25rem;">
        <h2>
          Pro Shop Mode
          <span class="pill pro-pill">$29 / mo</span>
        </h2>
        <p style="font-size:0.9rem; color:#9ca3af; margin-bottom:0.75rem;">
          VIN auto-decode, OEM-style guidance, customer history, and shop-grade quoting layered on top of the free estimator engine.
        </p>
        <button type="button" onclick="openPaywall()" class="access-button" style="max-width:220px; margin-top:0.25rem;">
          Upgrade to Pro
        </button>
        <p style="font-size:0.8rem; color:#6b7280; margin-top:0.5rem;">
          $29 / month or $290 / year. No contracts. Cancel any time.
        </p>
      </div>

      <div class="grid">
        <!-- LEFT: FORM -->
        <div class="card">
          <h2>
            Job Details
            <span class="pill">Estimator</span>
          </h2>

          <form id="estimateForm">
            <!-- Customer basics -->
            <div class="form-group">
              <label for="customerName">Customer Name *</label>
              <input id="customerName" type="text" placeholder="John Smith" required>
            </div>

            <div class="form-group">
              <label for="customerPhone">Phone</label>
              <input id="customerPhone" type="tel" placeholder="330-555-1212">
            </div>

            <div class="form-group">
              <label for="customerEmail">Email</label>
              <input id="customerEmail" type="email" placeholder="customer@example.com">
            </div>

            <!-- PRO SECTION -->
            <div class="pro-section">
              <div class="pro-header">
                <span class="pro-label">Pro Shop Tools</span>
                <span class="pro-tag">Pro</span>
              </div>
              <p class="pro-hint" id="proHintText">
                Free mode: these stay visible but locked so you can see what's coming when you upgrade.
              </p>

              <div class="form-group pro-feature">
                <label for="customerSelect">Saved Customers</label>
                <select id="customerSelect">
                  <option value="">+ New Customer</option>
                </select>
              </div>

              <div class="form-group pro-feature">
                <label for="vin">VIN Lookup (auto-fill vehicle)</label>
                <div class="flex-row">
                  <input id="vin" type="text" maxlength="17" placeholder="17-digit VIN" style="flex:1;">
                  <button type="button" id="vinLookupBtn" style="white-space:nowrap; padding:0.5rem 0.7rem; font-size:0.75rem;">
                    Lookup
                  </button>
                </div>
                <small id="vinStatus"></small>
              </div>

              <div class="form-group pro-feature">
                <label for="useOemData" style="display:flex; align-items:center; gap:0.4rem; cursor:pointer;">
                  <input type="checkbox" id="useOemData" style="width:auto;">
                  <span>Use OEM data (factory labor & notes)</span>
                </label>
                <small>Requires VIN and Pro access.</small>
              </div>
            </div>

            <!-- Always-on fields -->
            <div class="form-group">
              <label for="vehicle">Vehicle</label>
              <input id="vehicle" type="text" placeholder="2008 Ford F-150 5.4L V8">
            </div>

            <div class="form-group">
              <label for="laborRate">Your Labor Rate ($/hr)</label>
              <div class="flex-row">
                <span style="color:#22c55e; font-size:1.2rem;">$</span>
                <input
                  id="laborRate"
                  type="number"
                  value="65"
                  min="0"
                  max="200"
                  step="5"
                  style="max-width:120px;"
                >
                <span style="font-size:0.8rem; color:#9ca3af;">/hr</span>
              </div>
              <div class="quick-rate-row">
                <button type="button" class="quick-btn" data-rate="45">Friends $45</button>
                <button type="button" class="quick-btn" data-rate="65">Standard $65</button>
                <button type="button" class="quick-btn" data-rate="90">Premium $90</button>
              </div>
              <small>
                Adjust per job: Friends/Family (40–50) • Standard (50–75) • Premium (75–100).
              </small>
            </div>

            <div class="form-group">
              <label for="description">Job Description *</label>
              <textarea id="description" rows="4" placeholder="Example: Front brake pads & rotors, inspect calipers" required></textarea>
            </div>

            <div id="errorBox" class="error" style="display:none;"></div>
            <div id="successBox" class="success" style="display:none;"></div>

            <button type="submit" id="submitBtn">
              <span>⚡</span>
              <span>Generate Estimate</span>
            </button>
          </form>
        </div>

        <!-- RIGHT: ESTIMATE -->
        <div class="card">
          <h2>
            Estimate
            <span class="pill pro-pill">AI-Powered</span>
          </h2>
          <div id="estimateDisplay">
            <div class="empty-state">
              <strong>Nothing generated yet.</strong>
              Fill out the job details and hit <em>Generate Estimate</em> to see the breakdown.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PRO STRIPE PAYWALL MODAL -->
  <div id="proPaywall">
    <div class="paywall-card">
      <h2>Unlock Pro</h2>
      <p>Access code will be emailed right after payment. Use it here to turn on VIN & OEM tools.</p>
      <input id="proEmail" type="email" class="paywall-input" placeholder="you@example.com" />
      <button type="button" class="paywall-primary" onclick="startCheckout('pro_monthly')">
        $29 / Month
      </button>
      <button type="button" class="paywall-secondary" onclick="startCheckout('pro_yearly')">
        $290 / Year
      </button>
      <button type="button" class="paywall-cancel" onclick="closePaywall()">
        Cancel
      </button>
    </div>
  </div>

<script>
  const BACKEND_URL = window.location.hostname === "localhost"
    ? "http://localhost:4000"
    : "https://p613-backend.onrender.com";

  // Access gate elements
  const accessGate = document.getElementById("accessGate");
  const accessForm = document.getElementById("accessForm");
  const accessCodeInput = document.getElementById("accessCodeInput");
  const accessSubmit = document.getElementById("accessSubmit");
  const freeAccessBtn = document.getElementById("freeAccessBtn");
  const accessError = document.getElementById("accessError");
  const accessWelcome = document.getElementById("accessWelcome");

  // Main app elements
  const mainApp = document.getElementById("mainApp");
  const userInfo = document.getElementById("userInfo");

  const estimateForm = document.getElementById("estimateForm");
  const submitBtn = document.getElementById("submitBtn");
  const errorBox = document.getElementById("errorBox");
  const successBox = document.getElementById("successBox");
  const estimateDisplay = document.getElementById("estimateDisplay");

  const customerSelect = document.getElementById("customerSelect");
  const customerNameInput = document.getElementById("customerName");
  const customerPhoneInput = document.getElementById("customerPhone");
  const customerEmailInput = document.getElementById("customerEmail");
  const vehicleInput = document.getElementById("vehicle");
  const laborRateInput = document.getElementById("laborRate");
  const descriptionInput = document.getElementById("description");

  const vinInput = document.getElementById("vin");
  const vinLookupBtn = document.getElementById("vinLookupBtn");
  const vinStatus = document.getElementById("vinStatus");
  const useOemData = document.getElementById("useOemData");
  const proHintText = document.getElementById("proHintText");

  // Pro paywall elements
  const proPaywall = document.getElementById("proPaywall");
  const proEmailInput = document.getElementById("proEmail");

  let customers = [];
  let currentTier = "free";

  function setTierUI(tier) {
    currentTier = tier;
    const proFeatures = document.querySelectorAll(".pro-feature, #useOemData, #vinLookupBtn, #vin");

    if (tier === "free") {
      proFeatures.forEach(el => {
        el.classList.add("pro-disabled");
        if (el.tagName === "INPUT" || el.tagName === "SELECT" || el.tagName === "BUTTON") {
          el.disabled = true;
        }
      });
      proHintText.textContent = "Free mode: Pro shop tools are shown but locked.";
    } else {
      proFeatures.forEach(el => {
        el.classList.remove("pro-disabled");
        if (el.tagName === "INPUT" || el.tagName === "SELECT" || el.tagName === "BUTTON") {
          el.disabled = false;
        }
      });
      proHintText.textContent = "Pro: Saved customers, VIN lookup, and OEM integration are live.";
    }
  }

  function showError(msg) {
    errorBox.textContent = msg;
    errorBox.style.display = "block";
    successBox.style.display = "none";
  }

  function showSuccess(msg) {
    successBox.textContent = msg;
    successBox.style.display = "block";
    errorBox.style.display = "none";
  }

  function hideMessages() {
    errorBox.style.display = "none";
    successBox.style.display = "none";
  }

  function formatCurrency(amount) {
    const safe = Number.isFinite(amount) ? amount : 0;
    return new Intl.NumberFormat("en-US", {
      style: "currency",
      currency: "USD",
    }).format(safe);
  }

  function setLoadingEstimate() {
    estimateDisplay.innerHTML = `
      <div class="empty-state">
        <div class="spinner" style="width:40px;height:40px;border-width:3px;margin-bottom:0.75rem;"></div>
        <strong>AI is building your estimate...</strong>
        <span style="display:block;margin-top:0.25rem;color:#9ca3af;font-size:0.8rem;">
          Breaking it down into labor, parts, shop supplies, and your take-home.
        </span>
      </div>
    `;
  }

  function resetEstimatePlaceholder() {
    estimateDisplay.innerHTML = `
      <div class="empty-state">
        <strong>Nothing generated yet.</strong>
        Fill out the job details and hit <em>Generate Estimate</em>.
      </div>
    `;
  }

  function displayEstimate(est) {
    const laborRate = est.laborRate || Number(laborRateInput.value) || 65;
    const laborHours = est.laborHours || 0;
    const laborCost = est.laborCost ?? (laborHours * laborRate);
    const partsCost = est.partsCost || 0;
    const suppliesPercent = est.shopSuppliesPercent ?? 7;
    const shopSupplies = est.shopSupplies ?? ( (laborCost + partsCost) * (suppliesPercent / 100) );
    const subtotal = est.subtotal ?? (laborCost + partsCost + shopSupplies);
    const taxSetAside = subtotal * 0.28;
    const takeHome = subtotal - taxSetAside;

    const partsHTML = Array.isArray(est.parts) && est.parts.length > 0
      ? `
        <div class="info-box">
          <h3>Parts</h3>
          ${est.parts.map(p => `
            <div class="part-row">
              <span>${p.name}</span>
              <span>${formatCurrency(p.cost || 0)}</span>
            </div>
          `).join("")}
          <div class="part-row total">
            <span>Parts Total</span>
            <span>${formatCurrency(partsCost)}</span>
          </div>
        </div>
      `
      : "";

    estimateDisplay.innerHTML = `
      <div class="info-box">
        <h3>${est.jobType || "Repair / Service"}</h3>
        <p>${est.shortDescription || "AI-generated job overview."}</p>
      </div>

      <div class="info-box">
        <h3>Labor</h3>
        <div class="part-row">
          <span>${laborHours.toFixed(1)} hrs @ ${formatCurrency(laborRate)}/hr</span>
          <span>${formatCurrency(laborCost)}</span>
        </div>
      </div>

      ${partsHTML}

      <div class="info-box">
        <div class="part-row">
          <span>Shop Supplies (${suppliesPercent}%)</span>
          <span>${formatCurrency(shopSupplies)}</span>
        </div>
      </div>

      <div class="total-box">
        <span>Total Estimate</span>
        <span>${formatCurrency(subtotal)}</span>
      </div>

      <div class="tax-box">
        <div style="margin-bottom:0.25rem;color:#fde047;font-weight:600;font-size:0.8rem;">
          Tax Set-Aside (for you, not the customer)
        </div>
        <div class="tax-row">
          <span>Job Total</span>
          <span>${formatCurrency(subtotal)}</span>
        </div>
        <div class="tax-row">
          <span>Set aside ~28% for taxes</span>
          <span>-${formatCurrency(taxSetAside)}</span>
        </div>
        <div class="tax-row takehome">
          <span>Your Take-Home (after tax stash)</span>
          <span>${formatCurrency(takeHome)}</span>
        </div>
        <div class="tax-note">
          This tax line is for you only. Never shows on customer invoice.
        </div>
      </div>
    `;
  }

  // Access logic
  function unlockApp(access) {
    const tier = access.tier || "free";
    setTierUI(tier);

    accessGate.classList.add("hidden");
    mainApp.classList.add("visible");

    userInfo.innerHTML = `
      Logged in as: <strong>${access.customer || (tier === "pro" ? "Pro User" : "Free User")}</strong>
      (${tier === "pro" ? "Pro" : "Free – Limited"})
      <button type="button" onclick="logout()">Logout</button>
    `;

    if (tier === "pro") {
      loadCustomers();
    }
  }

  function logout() {
    localStorage.removeItem("sksk_autopro_access");
    location.reload();
  }
  window.logout = logout;

  async function loadCustomers() {
    try {
      const res = await fetch(`${BACKEND_URL}/api/customers`);
      if (!res.ok) return;
      const data = await res.json();
      if (data.ok && Array.isArray(data.customers)) {
        customers = data.customers;
        customerSelect.innerHTML = '<option value="">+ New Customer</option>';
        customers.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = `${c.name} (${c.phone || c.email || "no contact"})`;
          customerSelect.appendChild(opt);
        });
      }
    } catch (err) {
      console.error("Failed to load customers:", err);
    }
  }

  customerSelect.addEventListener("change", (e) => {
    const id = e.target.value;
    if (!id) {
      customerNameInput.value = "";
      customerPhoneInput.value = "";
      customerEmailInput.value = "";
      return;
    }
    const c = customers.find(x => x.id === id);
    if (c) {
      customerNameInput.value = c.name || "";
      customerPhoneInput.value = c.phone || "";
      customerEmailInput.value = c.email || "";
    }
  });

  vinLookupBtn.addEventListener("click", async () => {
    if (currentTier !== "pro") {
      vinStatus.textContent = "Pro feature – unlock with access code.";
      vinStatus.style.color = "#f97316";
      return;
    }

    const vin = vinInput.value.trim().toUpperCase();
    if (!vin || vin.length !== 17) {
      vinStatus.textContent = "Enter a full 17-character VIN.";
      vinStatus.style.color = "#fca5a5";
      return;
    }

    vinLookupBtn.disabled = true;
    vinLookupBtn.innerHTML = '<div class="spinner"></div>';
    vinStatus.textContent = "Looking up VIN...";
    vinStatus.style.color = "#9ca3af";

    try {
      const res = await fetch(`${BACKEND_URL}/api/vin-lookup/${vin}`);
      const data = await res.json();
      if (data.ok && data.displayString) {
        vehicleInput.value = data.displayString;
        vinStatus.textContent = "Vehicle auto-filled from VIN.";
        vinStatus.style.color = "#22c55e";
        vinInput.value = "";
      } else {
        vinStatus.textContent = "VIN lookup failed. Enter vehicle manually.";
        vinStatus.style.color = "#fca5a5";
      }
    } catch (err) {
      console.error("VIN lookup error:", err);
      vinStatus.textContent = "VIN lookup failed.";
      vinStatus.style.color = "#fca5a5";
    } finally {
      vinLookupBtn.disabled = false;
      vinLookupBtn.textContent = "Lookup";
    }
  });

  document.querySelectorAll(".quick-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const rate = Number(btn.getAttribute("data-rate") || 0);
      if (rate > 0) {
        laborRateInput.value = rate;
      }
    });
  });

  accessForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    accessError.style.display = "none";
    accessWelcome.style.display = "none";

    const code = accessCodeInput.value.trim().toUpperCase();
    if (!code) {
      accessError.textContent = "Enter a Pro access code.";
      accessError.style.display = "block";
      return;
    }

    accessSubmit.disabled = true;
    accessSubmit.innerHTML = '<span class="spinner"></span> Validating...';

    try {
      const res = await fetch(`${BACKEND_URL}/api/validate-access`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ accessCode: code }),
      });
      const data = await res.json();
      if (data.valid) {
        const accessData = {
          tier: data.tier || "pro",
          customer: data.customer || "Pro User",
          expires: data.expires || null,
        };
        localStorage.setItem("sksk_autopro_access", JSON.stringify(accessData));
        accessWelcome.textContent = data.message || "Pro unlocked.";
        accessWelcome.style.display = "block";
        setTimeout(() => unlockApp(accessData), 1000);
      } else {
        accessError.textContent = data.error || "Invalid access code.";
        accessError.style.display = "block";
      }
    } catch (err) {
      accessError.textContent = "Connection error. Try again.";
      accessError.style.display = "block";
    } finally {
      accessSubmit.disabled = false;
      accessSubmit.textContent = "Unlock Pro";
    }
  });

  freeAccessBtn.addEventListener("click", () => {
    const accessData = {
      tier: "free",
      customer: "Free User",
      expires: null,
    };
    localStorage.setItem("sksk_autopro_access", JSON.stringify(accessData));
    unlockApp(accessData);
  });

  window.addEventListener("DOMContentLoaded", () => {
    try {
      const stored = localStorage.getItem("sksk_autopro_access");
      if (stored) {
        const access = JSON.parse(stored);
        unlockApp(access);
      }
    } catch {
      localStorage.removeItem("sksk_autopro_access");
    }
  });

  // ESTIMATE FORM SUBMIT
  estimateForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    hideMessages();

    const name = customerNameInput.value.trim();
    const phone = customerPhoneInput.value.trim();
    const email = customerEmailInput.value.trim();
    const vehicle = vehicleInput.value.trim();
    const description = descriptionInput.value.trim();
    const laborRate = parseFloat(laborRateInput.value) || 65;
    const vinVal = vinInput.value.trim().toUpperCase();
    const useOem = currentTier === "pro" && useOemData.checked && vinVal.length === 17;

    if (!name || !description) {
      showError("Customer name and job description are required.");
      return;
    }

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner"></span> Generating...';
    setLoadingEstimate();

    const payload = {
      customer: { name, phone, email },
      vehicle,
      description,
      laborRate
    };

    if (useOem) {
      payload.useOemData = true;
      payload.vin = vinVal;
    }

    try {
      const res = await fetch(`${BACKEND_URL}/api/generate-estimate`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const errData = await res.json().catch(() => ({}));
        throw new Error(errData.error || `Server error: ${res.status}`);
      }

      const data = await res.json();
      if (!data.ok || !data.estimate) {
        throw new Error(data.error || "Failed to generate estimate.");
      }

      displayEstimate(data.estimate);
      showSuccess("Estimate generated successfully.");

      if (currentTier === "pro") {
        loadCustomers();
      }
    } catch (err) {
      console.error("Estimate error:", err);
      showError(err.message || "Failed to connect to server. Try again.");
      resetEstimatePlaceholder();
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span>⚡</span><span>Generate Estimate</span>';
    }
  });

  // ========================================
  // PRO PAYWALL + STRIPE CHECKOUT
  // ========================================
  function openPaywall() {
    if (!proPaywall) return;
    proPaywall.style.display = "flex";
  }

  function closePaywall() {
    if (!proPaywall) return;
    proPaywall.style.display = "none";
  }

  async function startCheckout(plan) {
    try {
      const email = (proEmailInput?.value || "").trim();
      if (!email) {
        alert("Enter your email to receive your Pro access code.");
        return;
      }

      const res = await fetch(`${BACKEND_URL}/api/create-checkout-session`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          plan,
          customerEmail: email
        })
      });

      const data = await res.json();
      if (data.url) {
        window.location.href = data.url;
      } else {
        alert(data.error || "Stripe error. Try again.");
      }
    } catch (err) {
      console.error("Checkout error:", err);
      alert("Unable to start checkout. Try again.");
    }
  }
</script>

</body>
</html>
