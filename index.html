<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SKSK ProTech ‚Äì AI Estimator</title>
<style>
body { background:#000; color:#fff; font-family:system-ui; padding:1rem; max-width:800px; margin:0 auto }
input, textarea, select, button { width:100%; padding:.6rem; margin:.3rem 0; background:#020617; color:#fff; border:1px solid #333; border-radius:8px; font-size:1rem }
button { background:#dc2626; font-weight:600; cursor:pointer; border:2px solid #b91c1c }
button:disabled{ opacity:.5; cursor:not-allowed }
.card{ background:#111827; border-radius:12px; padding:1rem; margin-bottom:1rem; border:1px solid #27272a }
.total-box{ background:linear-gradient(90deg,#dc2626,#b91c1c); padding:1rem; border-radius:10px; display:flex; justify-content:space-between; font-weight:700; font-size:1.1rem }
.error{ background:#dc262633; border:1px solid #dc2626; padding:.5rem; border-radius:8px; margin:.5rem 0; display:none }
.success{ background:#22c55e33; border:1px solid #22c55e; padding:.5rem; border-radius:8px; margin:.5rem 0; display:none }
.part-row{ display:flex; justify-content:space-between; font-size:.9rem; margin:.2rem 0 }
.tax-box{ border:1px solid #fbbf24; background:rgba(251,191,36,0.08); padding:.6rem; border-radius:8px; margin-top:.5rem; font-size:.85rem }
.tax-row{ display:flex; justify-content:space-between; margin:.15rem 0; color:#fef08a }
.takehome{ border-top:1px solid #fbbf24; padding-top:.3rem; margin-top:.3rem; font-weight:600; color:#fefce8 }
.pro-disabled{ opacity:.4; pointer-events:none }
.spinner{ display:inline-block; width:16px; height:16px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; animation:spin 0.8s linear infinite }
@keyframes spin{ to{transform:rotate(360deg)} }
h2{ margin-top:0 }
h3{ margin-bottom:.3rem; font-size:1rem }
ul{ margin:.3rem 0; padding-left:1.2rem; font-size:.85rem }
.info-box{ background:#020617; border:1px solid #27272a; padding:.6rem; border-radius:8px; margin-bottom:.5rem }
label{ display:block; font-size:.8rem; color:#9ca3af; margin-bottom:.2rem }
.quick-rate{ display:flex; gap:.3rem; margin-top:.3rem }
.quick-btn{ flex:1; padding:.4rem; font-size:.75rem; background:#020617; border:1px solid #374151; cursor:pointer }
.quick-btn:hover{ border-color:#dc2626; color:#f9fafb }
.pricing-card{ border:2px solid #dc2626; position:relative }
.pricing-card.best{ border-color:#22c55e }
.badge{ position:absolute; top:-10px; right:10px; background:#22c55e; color:#000; padding:.2rem .5rem; border-radius:4px; font-size:.7rem; font-weight:700 }
.price-display{ display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem }
.price-num{ font-size:2rem; font-weight:700; color:#dc2626 }
.best .price-num{ color:#22c55e }
.upgrade-btn{ background:#22c55e; color:#000; font-weight:700; margin-top:.5rem }
</style>
</head>
<body>

<!-- ACCESS GATE -->
<div id="accessGate">
  <div class="card">
    <h2>üîß SKSK ProTech</h2>
    <p style="color:#9ca3af; font-size:.9rem">AI-powered auto estimator for mobile mechanics</p>
    <input id="accessCodeInput" placeholder="ENTER PRO ACCESS CODE" style="text-transform:uppercase; letter-spacing:1px">
    <button id="accessBtn">üîì Unlock Pro</button>
    <button id="freeBtn" style="background:#374151; border-color:#4b5563">Start Free (Limited Features)</button>
    <div id="accessError" class="error"></div>
    <div id="accessSuccess" class="success"></div>
  </div>
</div>

<!-- PRICING PAGE -->
<div id="pricingPage" style="display:none">
  <div class="card" style="max-width:700px; margin:0 auto">
    <h2>üöÄ Upgrade to Pro</h2>
    <p style="color:#9ca3af; margin-bottom:1.5rem; font-size:.9rem">
      Get unlimited estimates, customer database, VIN lookup, invoice generation, expense tracking, and year-end tax reports.
    </p>

    <!-- Monthly Plan -->
    <div class="card pricing-card" style="margin-bottom:1rem">
      <div class="price-display">
        <div>
          <h3 style="margin:0">Pro Monthly</h3>
          <p style="color:#9ca3af; font-size:.8rem; margin:.2rem 0">Cancel anytime</p>
        </div>
        <div style="text-align:right">
          <div class="price-num">$29</div>
          <div style="font-size:.75rem; color:#9ca3af">per month</div>
        </div>
      </div>
      <button class="checkout-btn" data-plan="pro_monthly">Subscribe Monthly</button>
    </div>

    <!-- Yearly Plan -->
    <div class="card pricing-card best" style="margin-bottom:1rem">
      <div class="badge">SAVE $58/YR</div>
      <div class="price-display">
        <div>
          <h3 style="margin:0">Pro Yearly</h3>
          <p style="color:#9ca3af; font-size:.8rem; margin:.2rem 0">Best value - 2 months free</p>
        </div>
        <div style="text-align:right">
          <div class="price-num">$290</div>
          <div style="font-size:.75rem; color:#9ca3af">per year</div>
          <div style="font-size:.7rem; color:#9ca3af">($24/month)</div>
        </div>
      </div>
      <button class="checkout-btn" data-plan="pro_yearly" style="background:#22c55e; color:#000">Subscribe Yearly</button>
    </div>

    <!-- Features -->
    <div class="card" style="background:#020617">
      <h4 style="margin-bottom:.5rem">‚úÖ What You Get</h4>
      <ul style="font-size:.85rem; color:#9ca3af; line-height:1.7">
        <li>Unlimited AI estimates with 80+ flat rates</li>
        <li>Customer database (save & auto-fill)</li>
        <li>VIN lookup (auto-populate vehicle)</li>
        <li>Invoice generation (PDF ready)</li>
        <li>Payment tracking</li>
        <li>Expense logging</li>
        <li>Mileage tracking (IRS compliant)</li>
        <li>Year-end tax reports (Schedule C ready)</li>
        <li>Priority email support</li>
      </ul>
    </div>

    <button id="backToFreeBtn" style="background:#374151">‚Üê Back to Free Version</button>

    <p style="text-align:center; color:#6b7280; font-size:.7rem; margin-top:1rem">
      üîí Secure payment by Stripe ‚Ä¢ Cancel anytime, no questions asked
    </p>
  </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" style="display:none">
  <div class="card">
    <h2>üìã Job Details</h2>
    <div id="userInfo" style="background:rgba(34,197,94,0.1); border:1px solid #22c55e; padding:.5rem; border-radius:6px; font-size:.85rem; margin-bottom:1rem; color:#bbf7d0">
      <span id="tierLabel">Free Tier - Limited Features</span>
      <button id="logoutBtn" style="width:auto; padding:.3rem .6rem; font-size:.75rem; margin-left:.5rem; background:transparent; border:1px solid #dc2626; color:#fecaca">Logout</button>
    </div>

    <label>Customer Name *</label>
    <input id="customerName" placeholder="John Smith" required>
    
    <label>Phone</label>
    <input id="customerPhone" type="tel" placeholder="330-555-1212">
    
    <label>Email</label>
    <input id="customerEmail" type="email" placeholder="customer@example.com">

    <div class="pro-feature" style="border:1px dashed #374151; padding:.5rem; border-radius:8px; margin:.5rem 0">
      <label>üîí VIN Lookup (Pro Feature)</label>
      <div style="display:flex; gap:.3rem">
        <input id="vin" placeholder="17-digit VIN" maxlength="17" style="flex:1">
        <button id="vinLookupBtn" style="width:auto; padding:.5rem .7rem; white-space:nowrap; font-size:.8rem">Lookup</button>
      </div>
      <small id="vinStatus" style="color:#9ca3af; font-size:.7rem"></small>
    </div>

    <label>Vehicle</label>
    <input id="vehicle" placeholder="2008 Ford F-150 5.4L V8">
    
    <label>Your Labor Rate ($/hr)</label>
    <div style="display:flex; align-items:center; gap:.3rem">
      <span style="color:#22c55e; font-size:1.2rem">$</span>
      <input id="laborRate" type="number" value="65" min="0" max="200" step="5" style="max-width:100px">
      <span style="color:#9ca3af; font-size:.9rem">/hr</span>
    </div>
    <div class="quick-rate">
      <button class="quick-btn" data-rate="45">Friends $45</button>
      <button class="quick-btn" data-rate="65">Standard $65</button>
      <button class="quick-btn" data-rate="90">Premium $90</button>
    </div>
    <small style="color:#9ca3af; font-size:.75rem">Adjust per job: Friends (40-50) ‚Ä¢ Standard (50-75) ‚Ä¢ Premium (75-100)</small>

    <label>Job Description *</label>
    <textarea id="description" placeholder="Example: Water pump replacement, front brake pads and rotors" rows="4" required></textarea>

    <div id="errorBox" class="error"></div>
    <div id="successBox" class="success"></div>

    <button id="submitBtn">‚ö° Generate Estimate</button>
  </div>

  <div class="card">
    <h2>üí∞ Estimate</h2>
    <div id="estimateDisplay">
      <p style="color:#6b7280; text-align:center; padding:2rem">No estimate yet. Fill out job details above.</p>
    </div>
  </div>
</div>

<script>
const BACKEND_URL = location.hostname === "localhost" ? "http://localhost:4000" : "https://p613-backend.onrender.com";

// Elements
const accessGate = document.getElementById("accessGate");
const pricingPage = document.getElementById("pricingPage");
const mainApp = document.getElementById("mainApp");
const accessBtn = document.getElementById("accessBtn");
const freeBtn = document.getElementById("freeBtn");
const accessCodeInput = document.getElementById("accessCodeInput");
const accessError = document.getElementById("accessError");
const accessSuccess = document.getElementById("accessSuccess");
const errorBox = document.getElementById("errorBox");
const successBox = document.getElementById("successBox");
const submitBtn = document.getElementById("submitBtn");
const estimateDisplay = document.getElementById("estimateDisplay");
const vinLookupBtn = document.getElementById("vinLookupBtn");
const tierLabel = document.getElementById("tierLabel");
const logoutBtn = document.getElementById("logoutBtn");
const backToFreeBtn = document.getElementById("backToFreeBtn");

let currentTier = "free";

function formatCurrency(amt) {
  return new Intl.NumberFormat("en-US", {style:"currency", currency:"USD"}).format(amt || 0);
}

function setTierUI(mode){
  currentTier = mode;
  const proFeatures = document.querySelectorAll(".pro-feature");
  
  if(mode === "free"){
    proFeatures.forEach(el => {
      el.classList.add("pro-disabled");
      el.querySelectorAll("input,button").forEach(x => x.disabled = true);
    });
    tierLabel.innerHTML = 'üÜì Free Tier - Pro features locked <button id="upgradeBtn" class="upgrade-btn" style="width:auto; padding:.3rem .6rem; font-size:.75rem; margin-left:.5rem">‚¨ÜÔ∏è Upgrade</button>';
    
    // Add upgrade button click
    setTimeout(() => {
      const upgradeBtn = document.getElementById("upgradeBtn");
      if(upgradeBtn) upgradeBtn.onclick = showPricing;
    }, 100);
    
  } else {
    proFeatures.forEach(el => {
      el.classList.remove("pro-disabled");
      el.querySelectorAll("input,button").forEach(x => x.disabled = false);
    });
    tierLabel.textContent = "‚úÖ Pro Tier Active";
    tierLabel.style.borderColor = "#22c55e";
    tierLabel.style.background = "rgba(34,197,94,0.1)";
    tierLabel.style.color = "#bbf7d0";
  }
}

function showPricing() {
  accessGate.style.display = "none";
  mainApp.style.display = "none";
  pricingPage.style.display = "block";
}

function unlock(mode){
  setTierUI(mode);
  localStorage.setItem("sksk_tier", mode);
  accessGate.style.display = "none";
  pricingPage.style.display = "none";
  mainApp.style.display = "block";
}

// Access button
accessBtn.onclick = async () => {
  const code = accessCodeInput.value.trim().toUpperCase();
  if(!code){
    accessError.textContent = "Enter an access code";
    accessError.style.display = "block";
    return;
  }
  
  accessBtn.disabled = true;
  accessBtn.innerHTML = '<span class="spinner"></span> Validating...';
  
  try {
    const res = await fetch(`${BACKEND_URL}/api/validate-access`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({accessCode: code})
    });
    const data = await res.json();
    
    if(data.valid){
      accessSuccess.textContent = data.message || "Pro unlocked!";
      accessSuccess.style.display = "block";
      accessError.style.display = "none";
      setTimeout(() => unlock("pro"), 1000);
    } else {
      accessError.textContent = data.error || "Invalid code";
      accessError.style.display = "block";
      accessSuccess.style.display = "none";
    }
  } catch(err) {
    accessError.textContent = "Connection error. Try again.";
    accessError.style.display = "block";
  } finally {
    accessBtn.disabled = false;
    accessBtn.textContent = "üîì Unlock Pro";
  }
};

// Free button
freeBtn.onclick = () => unlock("free");

// Back to free
backToFreeBtn.onclick = () => {
  pricingPage.style.display = "none";
  mainApp.style.display = "block";
};

// Logout
logoutBtn.onclick = () => {
  localStorage.removeItem("sksk_tier");
  location.reload();
};

// Checkout buttons
document.querySelectorAll(".checkout-btn").forEach(btn => {
  btn.onclick = async () => {
    const plan = btn.getAttribute("data-plan");
    const email = prompt("Enter your email for subscription:");
    
    if(!email || !email.includes("@")){
      alert("Valid email required");
      return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Loading...';
    
    try {
      const res = await fetch(`${BACKEND_URL}/api/create-checkout-session`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          plan: plan,
          customerEmail: email,
          customerName: email.split("@")[0]
        })
      });
      
      const data = await res.json();
      
      if(!data.ok){
        throw new Error(data.error || "Failed");
      }
      
      // Redirect to Stripe
      window.location.href = data.url;
      
    } catch(err) {
      alert("Error: " + err.message);
      btn.disabled = false;
      btn.textContent = "Try Again";
    }
  };
});

// Handle Stripe return
const urlParams = new URLSearchParams(window.location.search);
if(urlParams.get("session_id")){
  alert("üéâ Payment successful! Check your email for your Pro access code.");
  window.location.href = window.location.pathname;
}
if(urlParams.get("canceled")){
  alert("Payment canceled. You can upgrade anytime.");
  window.location.href = window.location.pathname;
}

// VIN lookup
vinLookupBtn.onclick = async () => {
  if(currentTier !== "pro"){
    vinStatus.textContent = "Pro feature - unlock with code";
    vinStatus.style.color = "#f97316";
    return;
  }
  
  const vin = document.getElementById("vin").value.trim().toUpperCase();
  if(!vin || vin.length !== 17){
    vinStatus.textContent = "Enter 17-character VIN";
    vinStatus.style.color = "#fca5a5";
    return;
  }
  
  vinLookupBtn.disabled = true;
  vinLookupBtn.innerHTML = '<span class="spinner"></span>';
  vinStatus.textContent = "Looking up...";
  vinStatus.style.color = "#9ca3af";
  
  try {
    const res = await fetch(`${BACKEND_URL}/api/vin-lookup/${vin}`);
    const data = await res.json();
    if(data.ok && data.displayString){
      document.getElementById("vehicle").value = data.displayString;
      vinStatus.textContent = "‚úÖ Vehicle auto-filled";
      vinStatus.style.color = "#22c55e";
      document.getElementById("vin").value = "";
    } else {
      vinStatus.textContent = "VIN not found";
      vinStatus.style.color = "#fca5a5";
    }
  } catch(err) {
    vinStatus.textContent = "Lookup failed";
    vinStatus.style.color = "#fca5a5";
  } finally {
    vinLookupBtn.disabled = false;
    vinLookupBtn.textContent = "Lookup";
  }
};

// Quick rate buttons
document.querySelectorAll(".quick-btn").forEach(btn => {
  btn.onclick = () => {
    const rate = btn.getAttribute("data-rate");
    document.getElementById("laborRate").value = rate;
  };
});

// Generate estimate
submitBtn.onclick = async () => {
  errorBox.style.display = "none";
  successBox.style.display = "none";

  const name = customerName.value.trim();
  const description_val = description.value.trim();
  
  if(!name || !description_val){
    errorBox.textContent = "Customer name and job description required";
    errorBox.style.display = "block";
    return;
  }

  const payload = {
    customer: {
      name: customerName.value,
      phone: customerPhone.value,
      email: customerEmail.value
    },
    vehicle: vehicle.value,
    description: description_val,
    laborRate: Number(laborRate.value) || 65
  };

  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="spinner"></span> Generating...';
  estimateDisplay.innerHTML = '<div style="text-align:center; padding:2rem"><div class="spinner" style="width:40px; height:40px; border-width:3px"></div><p style="margin-top:1rem; color:#9ca3af">AI building estimate...</p></div>';

  try {
    const res = await fetch(`${BACKEND_URL}/api/generate-estimate`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if(!data.ok) throw new Error(data.error || "Failed");

    displayEstimate(data.estimate);
    successBox.textContent = "‚úÖ Estimate generated successfully";
    successBox.style.display = "block";
  } catch(err) {
    errorBox.textContent = err.message || "Connection error";
    errorBox.style.display = "block";
    estimateDisplay.innerHTML = '<p style="color:#6b7280; text-align:center; padding:2rem">Failed. Try again.</p>';
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = "‚ö° Generate Estimate";
  }
};

function displayEstimate(est) {
  const laborRate = est.laborRate || Number(laborRate.value) || 65;
  const laborHours = est.laborHours || 0;
  const laborCost = est.laborCost ?? (laborHours * laborRate);
  const partsCost = est.partsCost || 0;
  const suppliesPercent = est.shopSuppliesPercent ?? 7;
  const shopSupplies = est.shopSupplies ?? ((laborCost + partsCost) * (suppliesPercent / 100));
  const subtotal = est.subtotal ?? (laborCost + partsCost + shopSupplies);
  const taxSetAside = subtotal * 0.28;
  const takeHome = subtotal - taxSetAside;

  const partsHTML = Array.isArray(est.parts) && est.parts.length > 0
    ? `<div class="info-box">
        <h3>Parts</h3>
        ${est.parts.map(p => `<div class="part-row"><span>${p.name}</span><span>${formatCurrency(p.cost || 0)}</span></div>`).join("")}
        <div class="part-row" style="border-top:1px solid #374151; padding-top:.3rem; margin-top:.3rem; font-weight:600">
          <span>Parts Total</span><span>${formatCurrency(partsCost)}</span>
        </div>
      </div>`
    : "";

  const tipsHTML = Array.isArray(est.tips) && est.tips.length
    ? `<div class="info-box" style="border-color:#22c55e">
        <h3 style="color:#86efac">üí° Pro Tips</h3>
        <ul style="color:#bbf7d0">${est.tips.map(t => `<li>${t}</li>`).join("")}</ul>
      </div>`
    : "";

  const warningsHTML = Array.isArray(est.warnings) && est.warnings.length
    ? `<div class="info-box" style="border-color:#dc2626">
        <h3 style="color:#fecaca">‚ö†Ô∏è Watch For</h3>
        <ul style="color:#fecaca">${est.warnings.map(w => `<li>${w}</li>`).join("")}</ul>
      </div>`
    : "";

  estimateDisplay.innerHTML = `
    <div class="info-box">
      <h3>${est.jobType || "Repair"}</h3>
      <p style="color:#9ca3af; font-size:.85rem">${est.shortDescription || "AI-generated estimate"}</p>
    </div>

    <div class="info-box">
      <h3>Labor</h3>
      <div class="part-row">
        <span>${laborHours.toFixed(1)} hrs @ ${formatCurrency(laborRate)}/hr</span>
        <span>${formatCurrency(laborCost)}</span>
      </div>
    </div>

    ${partsHTML}

    <div class="info-box">
      <div class="part-row">
        <span>Shop Supplies (${suppliesPercent}%)</span>
        <span>${formatCurrency(shopSupplies)}</span>
      </div>
    </div>

    ${tipsHTML}
    ${warningsHTML}

    <div class="total-box">
      <span>Total Estimate</span>
      <span>${formatCurrency(subtotal)}</span>
    </div>

    <div class="tax-box">
      <div style="margin-bottom:.4rem; font-weight:600; color:#fde047">üí∞ Tax Set-Aside (for you only)</div>
      <div class="tax-row">
        <span>Job Total</span>
        <span>${formatCurrency(subtotal)}</span>
      </div>
      <div class="tax-row">
        <span>Set aside ~28% for taxes</span>
        <span>-${formatCurrency(taxSetAside)}</span>
      </div>
      <div class="tax-row takehome">
        <span>Your Take-Home (after tax stash)</span>
        <span>${formatCurrency(takeHome)}</span>
      </div>
      <small style="color:#fef08a; margin-top:.3rem; display:block; font-size:.7rem">This never shows on customer invoices.</small>
    </div>
  `;
}

// Check for existing session
window.addEventListener("DOMContentLoaded", () => {
  const savedTier = localStorage.getItem("sksk_tier");
  if(savedTier){
    unlock(savedTier);
  }
});
</script>
</body>
  </html>
