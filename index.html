<!DOCTYPE html>
<html>
<head>
  <title>SKSK ProTech - AI Auto Estimator</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
    .screen { display: none; } .screen.active { display: block; }
    button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
    textarea { height: 100px; resize: vertical; }
    .estimate { background: white; padding: 25px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .section { background: white; padding: 20px; border-radius: 8px; margin: 15px 0; }
    .price { font-size: 24px; font-weight: bold; color: #28a745; }
    #status { padding: 10px; border-radius: 6px; margin: 10px 0; }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    h1 { color: #333; text-align: center; }
    h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
    .loading { text-align: center; padding: 40px; color: #666; }
  </style>
</head>
<body>
  <!-- Access Screen -->
  <div id="accessScreen" class="screen active">
    <div class="section">
      <h1>üîß SKSK ProTech</h1>
      <p style="text-align: center; color: #666;">AI-Powered Auto Repair Estimator</p>
      <p>Enter your Pro Access Code:</p>
      <input id="accessCode" placeholder="Enter 8-character code (e.g. ABC123XY)" />
      <button onclick="validateAccess()">Unlock Pro Features</button>
      <div id="accessStatus"></div>
    </div>
  </div>

  <!-- Main Estimator -->
  <div id="mainScreen" class="screen">
    <button onclick="showAccess()" style="background: #6c757d;">‚Üê Back to Access</button>
    
    <div class="section">
      <h2>üìã Create New Estimate</h2>
      <input id="customerName" placeholder="Customer Name *" required />
      <input id="phone" placeholder="Phone (optional)" />
      <input id="vin" placeholder="VIN (17 characters)" maxlength="17" />
      <button onclick="decodeVin()" style="width: auto; margin-top: 5px;">üîç Decode VIN</button>
      <input id="vehicle" placeholder="Vehicle (auto-filled from VIN)" />
      <textarea id="description" placeholder="Describe the repair needed... (e.g. 'Replace water pump and flush coolant')" required></textarea>
      <input id="laborRate" type="number" step="0.01" placeholder="Labor Rate ($/hr)" value="65" min="50" max="200" />
      <button onclick="generateEstimate()">ü§ñ Generate AI Estimate</button>
    </div>

    <div id="estimateResult"></div>
    
    <div id="paySection" style="display:none;">
      <div class="section">
        <h3>üí≥ Pay Invoice</h3>
        <div id="payButton">
          <button onclick="createCheckout()">Pay with Stripe Card</button>
        </div>
        <div id="payStatus"></div>
      </div>
    </div>

    <div id="status"></div>
  </div>

  <script>
    // üîí SECURE CONFIG - NO KEYS IN FRONTEND
    const BACKEND_URL = 'https://p613-backend.onrender.com';
    let stripe = null;
    let currentJobId = null;
    let currentEstimate = null;
    let userTier = null;

    // Load Stripe securely from backend
    async function loadStripe() {
      if (stripe) return stripe;
      
      try {
        const res = await fetch(`${BACKEND_URL}/api/stripe-config`);
        const config = await res.json();
        if (config.publishableKey) {
          stripe = Stripe(config.publishableKey);
          return stripe;
        } else {
          throw new Error('Stripe config not available');
        }
      } catch (err) {
        console.error('Failed to load Stripe:', err);
        throw err;
      }
    }

    async function showStatus(message, isError = false) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = isError ? 'error' : 'success';
      statusEl.style.display = 'block';
      setTimeout(() => statusEl.style.display = 'none', 5000);
    }

    async function validateAccess() {
      const code = document.getElementById('accessCode').value.trim();
      if (!code) return showStatus('Enter access code', true);
      
      document.getElementById('accessStatus').innerHTML = 'üîç Validating...';
      
      try {
        const res = await fetch(`${BACKEND_URL}/api/validate-access`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({accessCode: code.toUpperCase()})
        });
        const data = await res.json();
        
        if (data.valid) {
          userTier = data.tier;
          document.getElementById('accessScreen').classList.remove('active');
          document.getElementById('mainScreen').classList.add('active');
          showStatus(`‚úÖ Welcome ${data.customer || 'Pro User'} (${data.tier})!`);
        } else {
          showStatus(data.error || 'Invalid code', true);
        }
      } catch (err) {
        showStatus('‚ùå Connection error. Check backend.', true);
      }
    }

    async function decodeVin() {
      const vin = document.getElementById('vin').value.trim().toUpperCase();
      if (vin.length !== 17) return showStatus('VIN must be 17 characters', true);
      
      try {
        const res = await fetch(`${BACKEND_URL}/api/vin-lookup/${vin}`);
        const data = await res.json();
        if (data.ok) {
          document.getElementById('vehicle').value = data.displayString;
          showStatus(`‚úÖ Found: ${data.displayString}`);
        } else {
          showStatus(data.error || 'VIN not found', true);
        }
      } catch (err) {
        showStatus('‚ùå VIN lookup failed', true);
      }
    }

    async function generateEstimate() {
      const customerName = document.getElementById('customerName').value.trim();
      const description = document.getElementById('description').value.trim();
      
      if (!customerName || !description) {
        return showStatus('Customer name and job description required', true);
      }
      
      document.getElementById('estimateResult').innerHTML = '<div class="loading">ü§ñ AI generating estimate...</div>';
      
      try {
        const data = {
          customer: {
            name: customerName,
            phone: document.getElementById('phone').value.trim()
          },
          vehicle: document.getElementById('vehicle').value.trim(),
          description,
          laborRate: parseFloat(document.getElementById('laborRate').value) || 65
        };
        
        const res = await fetch(`${BACKEND_URL}/api/generate-estimate`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        const result = await res.json();
        
        if (result.ok) {
          currentJobId = result.savedJob?.id || result.job?.id;
          currentEstimate = result.estimate;
          
          document.getElementById('estimateResult').innerHTML = `
            <div class="estimate">
              <h3>${result.estimate.shortDescription || 'Auto Repair Estimate'}</h3>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                <div>
                  <h4>üë∑ Labor</h4>
                  <p>${result.estimate.laborHours?.toFixed(1) || 0}h √ó $${result.estimate.laborRate}/hr</p>
                  <div class="price">$${result.estimate.laborCost?.toFixed(2) || 0}</div>
                </div>
                <div>
                  <h4>üî© Parts</h4>
                  <p>${(result.estimate.parts || []).length} items</p>
                  <div class="price">$${result.estimate.partsCost?.toFixed(2) || 0}</div>
                </div>
              </div>
              <div style="margin-top:20px;padding-top:20px;border-top:2px solid #eee;">
                <div style="display:flex;justify-content:space-between;">
                  <span>üõ†Ô∏è Shop Supplies (${result.estimate.shopSuppliesPercent || 7}%):</span>
                  <span>$${result.estimate.shopSupplies?.toFixed(2) || 0}</span>
                </div>
                <div style="display:flex;justify-content:space-between;font-size:20px;">
                  <strong>TOTAL</strong>
                  <div class="price">$${result.estimate.subtotal?.toFixed(2) || 0}</div>
                </div>
                ${result.estimate.recommendedTaxSetaside ? `
                  <div style="background:#fff3cd;padding:10px;border-radius:6px;margin-top:15px;">
                    üí∞ Recommended tax set-aside: $${result.estimate.recommendedTaxSetaside.toFixed(2)} (${result.estimate.taxRate}%)
                  </div>
                ` : ''}
              </div>
              ${result.estimate.workSteps?.length ? `
                <div style="margin-top:20px;">
                  <h4>üìù Work Steps:</h4>
                  <ol>${result.estimate.workSteps.map(step => `<li>${step}</li>`).join('')}</ol>
                </div>
              ` : ''}
              <div style="margin-top:15px;padding:10px;background:#e7f3ff;border-radius:6px;">
                üíæ Job ID: <strong>${currentJobId}</strong> (Saved to database)
              </div>
            </div>
          `;
          
          document.getElementById('paySection').style.display = 'block';
          showStatus('‚úÖ Estimate generated! Job saved to database.');
        } else {
          showStatus('‚ùå Estimate failed: ' + (result.error || 'Unknown error'), true);
        }
      } catch (err) {
        showStatus('‚ùå Connection error. Check backend.', true);
        console.error(err);
      }
    }

    async function createCheckout() {
      if (!currentJobId || !currentEstimate) {
        return showStatus('Generate estimate first', true);
      }
      
      try {
        // Load Stripe securely
        await loadStripe();
        
        document.getElementById('payStatus').innerHTML = 'üîÑ Creating secure payment link...';
        
        const res = await fetch(`${BACKEND_URL}/api/create-checkout-session`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            jobId: currentJobId,
            amount: currentEstimate.subtotal || 250
          })
        });
        const data = await res.json();
        
        if (data.url) {
          document.getElementById('payStatus').innerHTML = '‚úÖ Redirecting to Stripe...';
          window.location.href = data.url;
        } else {
          showStatus('‚ùå Payment setup failed', true);
        }
      } catch (err) {
        showStatus('‚ùå Payment error. Check Stripe setup.', true);
        console.error(err);
      }
    }

    function showAccess() {
      document.getElementById('mainScreen').classList.remove('active');
      document.getElementById('accessScreen').classList.add('active');
    }

    // Enter key support
    document.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        if (document.getElementById('accessScreen').classList.contains('active')) {
          validateAccess();
        }
      }
    });

    // Auto-load Stripe config on page load
    window.addEventListener('load', async () => {
      try {
        await loadStripe();
      } catch (err) {
        console.warn('Stripe will load on first payment');
      }
    });
  </script>
</body>
</html>
